/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * ZeitErfassungView.java
 *
 * Created on 06.06.2011, 15:31:47
 */
package view;

import controller.Binder;
import controller.BinderProperty;
import controller.ZeitErfassungController;
import java.io.File;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.logging.Level;
import javax.swing.Action;
import javax.swing.DefaultListModel;
import javax.swing.JFileChooser;
import javax.swing.filechooser.FileSystemView;
import model.AbstractObject;
import model.Arbeitsstunden;
import model.Mitarbeiter;
import model.Projekt;
import model.dal.DALException;
import model.dal.DALFactory;
import model.dal.IDAL;
import utils.csv.SaveFileAction;
import utils.csv.OpenFileAction;
import utils.csv.CSVFilter;
import utils.log.Logger;

/**
 *
 * @author Goran-Goggy
 */
public class ZeitErfassungView extends AbstractViewPanel {

    private ZeitErfassungController controller;
    private IDAL db = DALFactory.getDAL();
    private FileSystemView fsv = FileSystemView.getFileSystemView();
    private JFileChooser fc = new JFileChooser(fsv.getRoots()[0]);
// Create the actions
    private Action openAction = new OpenFileAction(this, fc);
    private Action saveAction = new SaveFileAction(this, fc);
    private File f;

    /** Creates new form ProjektView */
    public ZeitErfassungView(ZeitErfassungController controller) {
        this.controller = controller;
        initComponents();
        initialize();
    }

    private void initialize() {
        fc.addChoosableFileFilter(new CSVFilter());

        Binder.bind(Arbeitsstunden.class, logListe);
        Binder.bind(Projekt.class, logProjektComboBox);
        Binder.bind(Mitarbeiter.class, logMitarbeiterComboBox);

        Binder.bind(logListe, logProjektComboBox);
        Binder.bind(logListe, logMitarbeiterComboBox);
        Binder.bind(logListe, logDatumDateChooser);
        Binder.bind(logListe, logStundenFeld);
        Binder.bind(logListe, logTaetigkeitFeld);
        Binder.bind(logListe, logLoeschen);
        Binder.bind(logListe, projektAendern1);
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        logListeLabel = new javax.swing.JLabel();
        logInfoLabel = new javax.swing.JLabel();
        jScrollPane1 = new javax.swing.JScrollPane();
        logListe = new javax.swing.JList();
        logMitarbeiterIDLabel = new javax.swing.JLabel();
        projektImplementierungVonLabel = new javax.swing.JLabel();
        projektExport = new javax.swing.JButton(saveAction);
        projektImport = new javax.swing.JButton(openAction);
        logProjektIdLabell = new javax.swing.JLabel();
        logHinzufuegen = new javax.swing.JButton();
        logLoeschen = new javax.swing.JButton();
        logPdfErstellen = new javax.swing.JButton();
        logDatumDateChooser = new com.toedter.calendar.JDateChooser();
        logMitarbeiterStundenLabel = new javax.swing.JLabel();
        logStundenFeld = new javax.swing.JTextField();
        logTaetigkeitLabel = new javax.swing.JLabel();
        jScrollPane3 = new javax.swing.JScrollPane();
        logTaetigkeitFeld = new javax.swing.JTextArea();
        projektAendern1 = new javax.swing.JButton();
        logProjektComboBox = new javax.swing.JComboBox();
        logMitarbeiterComboBox = new javax.swing.JComboBox();

        setEnabled(false);
        setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        logListeLabel.setFont(new java.awt.Font("Arial", 1, 14));
        logListeLabel.setText("Logeinträge");
        add(logListeLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 10, -1, -1));

        logInfoLabel.setFont(new java.awt.Font("Arial", 1, 14));
        logInfoLabel.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        logInfoLabel.setText("Logeintrag");
        logInfoLabel.setAlignmentX(0.5F);
        add(logInfoLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(230, 10, -1, -1));

        logListe.setFont(new java.awt.Font("Tahoma", 2, 12));
        logListe.setSelectionMode(javax.swing.ListSelectionModel.SINGLE_SELECTION);
        logListe.setName("ArbeitsstundenListe"); // NOI18N
        jScrollPane1.setViewportView(logListe);

        add(jScrollPane1, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 40, 200, 190));

        logMitarbeiterIDLabel.setFont(new java.awt.Font("Tahoma", 0, 15));
        logMitarbeiterIDLabel.setText("Mitarbeiter");
        add(logMitarbeiterIDLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(500, 40, -1, -1));

        projektImplementierungVonLabel.setFont(new java.awt.Font("Tahoma", 0, 15));
        projektImplementierungVonLabel.setText("Gearbeitet am");
        add(projektImplementierungVonLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(230, 80, -1, -1));

        projektExport.setText("Datensätze exportieren");
        add(projektExport, new org.netbeans.lib.awtextra.AbsoluteConstraints(770, 80, 230, -1));

        projektImport.setText("Datensätze Importieren");
        projektImport.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                projektImportActionPerformed(evt);
            }
        });
        add(projektImport, new org.netbeans.lib.awtextra.AbsoluteConstraints(770, 40, 230, -1));

        logProjektIdLabell.setFont(new java.awt.Font("Tahoma", 0, 15));
        logProjektIdLabell.setText("Projekt");
        add(logProjektIdLabell, new org.netbeans.lib.awtextra.AbsoluteConstraints(230, 40, -1, -1));

        logHinzufuegen.setText("Logeintrag erstellen");
        logHinzufuegen.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                logHinzufuegenActionPerformed(evt);
            }
        });
        add(logHinzufuegen, new org.netbeans.lib.awtextra.AbsoluteConstraints(240, 240, 230, -1));

        logLoeschen.setText("Logeintrag löschen");
        logLoeschen.setEnabled(false);
        logLoeschen.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                logLoeschenActionPerformed(evt);
            }
        });
        add(logLoeschen, new org.netbeans.lib.awtextra.AbsoluteConstraints(760, 240, 230, -1));

        logPdfErstellen.setText("PDF erstellen");
        logPdfErstellen.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                logPdfErstellenActionPerformed(evt);
            }
        });
        add(logPdfErstellen, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 240, 200, -1));

        logDatumDateChooser.setEnabled(false);
        logDatumDateChooser.setName("Datum"); // NOI18N
        add(logDatumDateChooser, new org.netbeans.lib.awtextra.AbsoluteConstraints(330, 80, 150, -1));

        logMitarbeiterStundenLabel.setFont(new java.awt.Font("Tahoma", 0, 15));
        logMitarbeiterStundenLabel.setText("Stunden");
        add(logMitarbeiterStundenLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(500, 80, -1, -1));

        logStundenFeld.setEnabled(false);
        logStundenFeld.setName("Stunden"); // NOI18N
        logStundenFeld.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                logStundenFeldActionPerformed(evt);
            }
        });
        add(logStundenFeld, new org.netbeans.lib.awtextra.AbsoluteConstraints(600, 80, 150, -1));

        logTaetigkeitLabel.setFont(new java.awt.Font("Tahoma", 0, 15));
        logTaetigkeitLabel.setText("Tätigkeiten");
        add(logTaetigkeitLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(230, 120, -1, -1));

        logTaetigkeitFeld.setColumns(20);
        logTaetigkeitFeld.setRows(5);
        logTaetigkeitFeld.setEnabled(false);
        logTaetigkeitFeld.setName("Taetigkeit"); // NOI18N
        jScrollPane3.setViewportView(logTaetigkeitFeld);

        add(jScrollPane3, new org.netbeans.lib.awtextra.AbsoluteConstraints(230, 140, 770, 90));

        projektAendern1.setText("Logeintrag sichern");
        projektAendern1.setEnabled(false);
        projektAendern1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                projektAendern1ActionPerformed(evt);
            }
        });
        add(projektAendern1, new org.netbeans.lib.awtextra.AbsoluteConstraints(500, 240, 230, -1));

        logProjektComboBox.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));
        logProjektComboBox.setEnabled(false);
        logProjektComboBox.setName("Projekt"); // NOI18N
        add(logProjektComboBox, new org.netbeans.lib.awtextra.AbsoluteConstraints(330, 40, 150, -1));

        logMitarbeiterComboBox.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));
        logMitarbeiterComboBox.setEnabled(false);
        logMitarbeiterComboBox.setName("Mitarbeiter"); // NOI18N
        add(logMitarbeiterComboBox, new org.netbeans.lib.awtextra.AbsoluteConstraints(600, 40, 150, -1));
    }// </editor-fold>//GEN-END:initComponents

    private void projektAendern1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_projektAendern1ActionPerformed
        if (this.logListe.isSelectionEmpty()) {
            return;
        }
        
        ArrayList<String> errorList;
        errorList = Binder.save(Arbeitsstunden.class, createBinderPropertiesFromFields());
        showErrors(errorList);
}//GEN-LAST:event_projektAendern1ActionPerformed

    private void logStundenFeldActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_logStundenFeldActionPerformed
        // TODO add your handling code here:
}//GEN-LAST:event_logStundenFeldActionPerformed

    private void logPdfErstellenActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_logPdfErstellenActionPerformed
        //KontaktAddForm af = new KontaktAddForm(null, true);
        //af.setVisible(true);
}//GEN-LAST:event_logPdfErstellenActionPerformed

    private void logLoeschenActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_logLoeschenActionPerformed
        Arbeitsstunden a = (Arbeitsstunden) this.logListe.getSelectedValue();
        try {
            if(!(logListe.isSelectionEmpty())){
                db.deleteArbeitsstunden(a);
            }
        } catch (DALException ex) {
            Logger.log(Level.SEVERE, KontakteView.class, ex);
        }
}//GEN-LAST:event_logLoeschenActionPerformed

    private void logHinzufuegenActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_logHinzufuegenActionPerformed
        DefaultListModel model = (DefaultListModel) logListe.getModel();
        // solange ein nicht gespeicherter Kontakt, kein neuer Kontakt
        if (model.getSize() > 0 && ((Arbeitsstunden) model.getElementAt(model.getSize() - 1)).getId() == 0) {
            return;
        }
        Arbeitsstunden a = new Arbeitsstunden();
        a.setId(0);
        model.addElement(a);
        logListe.setSelectedIndex(model.getSize() - 1);
        this.resetFields();
}//GEN-LAST:event_logHinzufuegenActionPerformed

    private void projektImportActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_projektImportActionPerformed
        
}//GEN-LAST:event_projektImportActionPerformed

    private ArrayList<BinderProperty> createBinderPropertiesFromFields() {
        ArrayList list = new ArrayList<BinderProperty>();
        SimpleDateFormat sdf = new SimpleDateFormat("dd.MM.yyyy");

        list.add(new BinderProperty(logStundenFeld.getName(), logStundenFeld.getText(), Integer.class));
        list.add(new BinderProperty(logDatumDateChooser.getName(), logDatumDateChooser.getDate() != null ? sdf.format(logDatumDateChooser.getDate()) : "", Date.class));
        list.add(new BinderProperty(logTaetigkeitFeld.getName(), logTaetigkeitFeld.getText(), String.class));
        if (logProjektComboBox.getSelectedItem() instanceof Projekt) {
            list.add(new BinderProperty("Projekt", ((Projekt) logProjektComboBox.getSelectedItem()).getId().toString(), AbstractObject.class));
        } else {
            list.add(new BinderProperty("Projekt", "", AbstractObject.class));
        }
        if (logMitarbeiterComboBox.getSelectedItem() instanceof Mitarbeiter) {
            list.add(new BinderProperty("Mitarbeiter", ((Mitarbeiter) logMitarbeiterComboBox.getSelectedItem()).getId().toString(), AbstractObject.class));
        } else {
            list.add(new BinderProperty("Mitarbeiter", "", AbstractObject.class));
        }
        Arbeitsstunden a = (Arbeitsstunden) logListe.getSelectedValue();
        if (a != null) {
            list.add(new BinderProperty("Id", a.getId().toString(), Integer.class));
        } else {
            list.add(new BinderProperty("Id", "0", Integer.class));
        }
        return list;
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane3;
    private com.toedter.calendar.JDateChooser logDatumDateChooser;
    private javax.swing.JButton logHinzufuegen;
    private javax.swing.JLabel logInfoLabel;
    private javax.swing.JList logListe;
    private javax.swing.JLabel logListeLabel;
    private javax.swing.JButton logLoeschen;
    private javax.swing.JComboBox logMitarbeiterComboBox;
    private javax.swing.JLabel logMitarbeiterIDLabel;
    private javax.swing.JLabel logMitarbeiterStundenLabel;
    private javax.swing.JButton logPdfErstellen;
    private javax.swing.JComboBox logProjektComboBox;
    private javax.swing.JLabel logProjektIdLabell;
    private javax.swing.JTextField logStundenFeld;
    private javax.swing.JTextArea logTaetigkeitFeld;
    private javax.swing.JLabel logTaetigkeitLabel;
    private javax.swing.JButton projektAendern1;
    private javax.swing.JButton projektExport;
    private javax.swing.JLabel projektImplementierungVonLabel;
    private javax.swing.JButton projektImport;
    // End of variables declaration//GEN-END:variables
}
