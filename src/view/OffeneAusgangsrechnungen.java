/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * OffeneEingangsrechnungen.java
 *
 * Created on 08.06.2011, 18:43:55
 */
package view;

import controller.Binder;
import controller.OffeneAusgangsrechnungenController;
import java.util.Date;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.DefaultListModel;
import model.ARechnung;
import model.Buchungszeile;
import model.BuchungszeilenEintrag;
import model.ERechnung;
import model.Kategorie;
import model.Rechnung;
import model.dal.DALException;
import model.dal.DALFactory;
import model.dal.IDAL;

/**
 *
 * @author Goran-Goggy
 */
public class OffeneAusgangsrechnungen extends javax.swing.JPanel {
    private OffeneAusgangsrechnungenController controller;
    private IDAL db = DALFactory.getDAL();
    /** Creates new form OffeneEingangsrechnungen */
    public OffeneAusgangsrechnungen(OffeneAusgangsrechnungenController controller) {
        this.controller = controller;
        initComponents();
        initialize();
    }
    
    private void initialize() {
        Binder.bind(ARechnung.class, offeneAusgangsrechnungenListe);
        Binder.bind(ERechnung.class, rechnungKategorieComboBox);
    }
    
    

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        projektAuftragLabel = new javax.swing.JLabel();
        rechnungKategorieComboBox = new javax.swing.JComboBox();
        kundenListeLabel = new javax.swing.JLabel();
        kundenInfoLabel = new javax.swing.JLabel();
        projektNameLabel = new javax.swing.JLabel();
        rechnungenBetragFeld = new javax.swing.JTextField();
        projektHinzufuegen1 = new javax.swing.JButton();
        projektLoeschen = new javax.swing.JButton();
        jScrollPane1 = new javax.swing.JScrollPane();
        rechnungenListe = new javax.swing.JList();
        jScrollPane2 = new javax.swing.JScrollPane();
        offeneAusgangsrechnungenListe = new javax.swing.JList();

        setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jPanel1.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        projektAuftragLabel.setFont(new java.awt.Font("Tahoma", 0, 15));
        projektAuftragLabel.setText("Kategorie");
        jPanel1.add(projektAuftragLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(360, 120, -1, -1));

        rechnungKategorieComboBox.setName("KategorieListe"); // NOI18N
        jPanel1.add(rechnungKategorieComboBox, new org.netbeans.lib.awtextra.AbsoluteConstraints(430, 120, 160, -1));

        kundenListeLabel.setFont(new java.awt.Font("Arial", 1, 14));
        kundenListeLabel.setText("Offene Ausgangsrechnungen");
        jPanel1.add(kundenListeLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 10, -1, -1));

        kundenInfoLabel.setFont(new java.awt.Font("Arial", 1, 14));
        kundenInfoLabel.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        kundenInfoLabel.setText("Vorgemerkte Ausgangsrechnungen");
        kundenInfoLabel.setAlignmentX(0.5F);
        jPanel1.add(kundenInfoLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(640, 10, -1, -1));

        projektNameLabel.setFont(new java.awt.Font("Tahoma", 0, 15));
        projektNameLabel.setText("Betrag");
        jPanel1.add(projektNameLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(360, 80, -1, -1));

        rechnungenBetragFeld.setName("Name"); // NOI18N
        rechnungenBetragFeld.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                rechnungenBetragFeldActionPerformed(evt);
            }
        });
        jPanel1.add(rechnungenBetragFeld, new org.netbeans.lib.awtextra.AbsoluteConstraints(430, 80, 160, -1));

        projektHinzufuegen1.setText("Vormerken");
        projektHinzufuegen1.setName("KategorieListe"); // NOI18N
        projektHinzufuegen1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                projektHinzufuegen1ActionPerformed(evt);
            }
        });
        jPanel1.add(projektHinzufuegen1, new org.netbeans.lib.awtextra.AbsoluteConstraints(390, 160, 170, 30));

        projektLoeschen.setText("Rechnungen abbuchen");
        projektLoeschen.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                projektLoeschenActionPerformed(evt);
            }
        });
        jPanel1.add(projektLoeschen, new org.netbeans.lib.awtextra.AbsoluteConstraints(640, 210, 250, -1));

        rechnungenListe.setFont(new java.awt.Font("Tahoma", 2, 12));
        rechnungenListe.setSelectionMode(javax.swing.ListSelectionModel.SINGLE_SELECTION);
        rechnungenListe.setName("ProjektListe"); // NOI18N
        jScrollPane1.setViewportView(rechnungenListe);

        jPanel1.add(jScrollPane1, new org.netbeans.lib.awtextra.AbsoluteConstraints(640, 40, 250, 160));

        offeneAusgangsrechnungenListe.setFont(new java.awt.Font("Tahoma", 2, 12)); // NOI18N
        offeneAusgangsrechnungenListe.setSelectionMode(javax.swing.ListSelectionModel.SINGLE_SELECTION);
        offeneAusgangsrechnungenListe.setName("AusgangsrechnungListe"); // NOI18N
        jScrollPane2.setViewportView(offeneAusgangsrechnungenListe);

        jPanel1.add(jScrollPane2, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 40, 280, 190));

        add(jPanel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 0, 906, 250));
    }// </editor-fold>//GEN-END:initComponents

    private void rechnungenBetragFeldActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_rechnungenBetragFeldActionPerformed
        // TODO add your handling code here:
}//GEN-LAST:event_rechnungenBetragFeldActionPerformed

    private void projektHinzufuegen1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_projektHinzufuegen1ActionPerformed
        if(offeneAusgangsrechnungenListe.isSelectionEmpty() || (!(offeneAusgangsrechnungenListe.getSelectedValue() instanceof ARechnung))) {
            return;
        }
        
        ARechnung ar = (ARechnung)offeneAusgangsrechnungenListe.getSelectedValue();
        
        BuchungszeilenEintrag eintrag = new BuchungszeilenEintrag();
        eintrag.setRechnung_id(ar.getId());
        Double betrag = Double.parseDouble(rechnungenBetragFeld.getText());
        if(betrag != null && betrag > 0) {
            if(betrag > ar.getPreis())
                return;
            
            ar.setPreis(ar.getPreis()-betrag);
            if(ar.getPreis() == 0)
                eintrag.setIsBezahlt(true);
            else
                eintrag.setIsBezahlt(false);
            eintrag.setBetrag(betrag);
        } else {
            return;
        }
        Object kategorie = rechnungKategorieComboBox.getSelectedItem();
        if(kategorie instanceof Kategorie && kategorie != null) {
            eintrag.setKategorie((Kategorie)kategorie);
        }
        DefaultListModel model;
        if(rechnungenListe.getModel() instanceof DefaultListModel && rechnungenListe.getModel() != null) {
            model = (DefaultListModel)rechnungenListe.getModel();
        } else {
            model = new DefaultListModel();
            rechnungenListe.setModel(model);
        }
        
        model.addElement(eintrag);
        offeneAusgangsrechnungenListe.clearSelection();
    }//GEN-LAST:event_projektHinzufuegen1ActionPerformed

    private void projektLoeschenActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_projektLoeschenActionPerformed
        Buchungszeile b = new Buchungszeile();
        b.setDatum(new Date());
        try {
            b = db.saveBuchungszeile(b);
        } catch (DALException ex) {
            Logger.getLogger(OffeneEingangsrechnungen.class.getName()).log(Level.SEVERE, null, ex);
        }

        for(int i = 0; i <rechnungenListe.getModel().getSize(); i++) {
            if (!(rechnungenListe.getModel().getElementAt(i) instanceof BuchungszeilenEintrag)) 
                return;
            Rechnung rechnung = new Rechnung();
            
            BuchungszeilenEintrag bz = (BuchungszeilenEintrag)rechnungenListe.getModel().getElementAt(i);
            ARechnung ar = new ARechnung();
            ar.setId(bz.getRechnung_id());
            rechnung.setAusgangsrechnung(ar);
            rechnung.setDatum(new Date());
            
            rechnung.setIsBezahlt(bz.getIsBezahlt());
            try {
                db.saveRechnung(rechnung);
            } catch (DALException ex) {
                Logger.getLogger(OffeneAusgangsrechnungen.class.getName()).log(Level.SEVERE, null, ex);
            }
            try {
                db.addRechnungToBuchungszeile(bz.getRechnung_id(), bz.getKategorie().getId(), bz.getBetrag(), b.getId());
            } catch (DALException ex) {
                Logger.getLogger(OffeneEingangsrechnungen.class.getName()).log(Level.SEVERE, null, ex);
            }
        }
    }//GEN-LAST:event_projektLoeschenActionPerformed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JPanel jPanel1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JLabel kundenInfoLabel;
    private javax.swing.JLabel kundenListeLabel;
    private javax.swing.JList offeneAusgangsrechnungenListe;
    private javax.swing.JLabel projektAuftragLabel;
    private javax.swing.JButton projektHinzufuegen1;
    private javax.swing.JButton projektLoeschen;
    private javax.swing.JLabel projektNameLabel;
    private javax.swing.JComboBox rechnungKategorieComboBox;
    private javax.swing.JTextField rechnungenBetragFeld;
    private javax.swing.JList rechnungenListe;
    // End of variables declaration//GEN-END:variables
}
